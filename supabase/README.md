# Supabase Edge Function for Secure Command Execution

This project implements a secure intermediary using Supabase Edge Functions that can accept validated commands (such as SQL queries) generated by an AI system, authenticate the request using a secure API key, and execute those commands against a Supabase project using elevated privileges.

## Project Structure

```
supabase/
├── functions/
│   └── execute-command/
│       └── index.ts       # The Edge Function implementation
├── execute_sql_as_super_user.sql  # SQL function to execute with elevated privileges
└── README.md              # This documentation file
```

## Deployment Instructions

Follow these steps to deploy the Edge Function to your Supabase project:

### 1. Prerequisites

- Install the Supabase CLI:
  ```bash
  npm install -g supabase
  ```

- Log in to your Supabase account:
  ```bash
  supabase login
  ```

### 2. Initialize Supabase Project

Navigate to your project directory and initialize a Supabase project:

```bash
supabase init
```

### 3. Create and Deploy the Edge Function

```bash
# Create the Edge Function (if not already created)
supabase functions new execute-command

# Set up the required secrets (environment variables)
supabase secrets set API_SECRET_KEY=your-secure-api-key
supabase secrets set SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Deploy the function without JWT verification
supabase functions deploy execute-command --no-verify-jwt
```

**Note:** The `--no-verify-jwt` flag is used because we're implementing our own authentication via API key. In a production environment, you might want to use both JWT and API key authentication.

### 4. Create the SQL Helper Function

In the Supabase dashboard:

1. Navigate to the SQL Editor
2. Open the `execute_sql_as_super_user.sql` file from this repository
3. Execute the SQL script to create the function with elevated privileges

## Usage

Once deployed, you can call the Edge Function using HTTP requests:

### Example: Execute a SQL Query

```bash
curl -X POST https://your-project-ref.supabase.co/functions/v1/execute-command \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "x-api-key: your-secure-api-key" \
  -d '{
    "command": "SELECT * FROM your_table LIMIT 5",
    "type": "sql"
  }'
```

### Example: Call a Stored Procedure

```bash
curl -X POST https://your-project-ref.supabase.co/functions/v1/execute-command \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "x-api-key: your-secure-api-key" \
  -d '{
    "command": "your_stored_procedure",
    "params": {
      "param1": "value1",
      "param2": "value2"
    },
    "type": "rpc"
  }'
```

## Security Considerations

This implementation includes the following security features:

1. **API Key Authentication**: Requests must include a valid API key in the `x-api-key` header.
2. **Command Validation**: Basic validation prevents potentially dangerous SQL operations.
3. **Secure Environment Variables**: Sensitive keys are stored as Supabase secrets.
4. **Error Handling and Logging**: Comprehensive error handling and structured logging.

**Important Security Notes:**

- The SQL function `execute_sql_as_super_user` runs with elevated privileges (SECURITY DEFINER).
- This implementation should be extended with more granular command validation in production.
- The API key should be strong, kept confidential, and rotated regularly.
- Consider restricting the CORS headers to specific origins in production.

## Troubleshooting

- **Connection Issues**: Ensure your Supabase project is running and the credentials are correct.
- **Authentication Failures**: Verify the API key is correctly set in the request headers.
- **SQL Execution Errors**: Check the SQL query syntax and ensure the `execute_sql_as_super_user` function exists in your database.
